<% layout('layouts/boilerplate') %>

<% 
  const categoryMapper = {
    "Rooms": { icon: "fa-bed", label: "Private Room" },
    "Hotels": { icon: "fa-hotel", label: "Boutique Hotel" },
    "Entire Home": { icon: "fa-house-user", label: "Entire Home" },
    "Cabins": { icon: "fa-cabin-house", label: "Cabin" },
    "Luxe": { icon: "fa-gem", label: "Luxe Stay" },
  
  };
  const categoryData = categoryMapper[listing.category] || { icon: "fa-house", label: "Listing" };
%>

<div class="listing-form-wrapper py-5">
  <div class="container" style="max-width: 850px;">
    
    <div class="mb-5 d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-3">
        <a href="/listings/<%= listing._id %>" class="btn btn-outline-dark rounded-circle d-flex align-items-center justify-content-center shadow-sm" style="width:45px; height:45px;">
          <span class="material-symbols-outlined">arrow_back</span>
        </a>
        <div>
          <h2 class="fw-bold mb-0">Edit Your Space</h2>
          <p class="text-muted small mb-0">Property ID: #<%= listing._id.toString().slice(-6).toUpperCase() %></p>
        </div>
      </div>
      <span class="badge bg-white text-dark border px-3 py-2 rounded-pill shadow-sm">
        <i class="fa-solid fa-pen-to-square text-primary me-1"></i> Edit Mode
      </span>
    </div>

    <div class="card border-0 shadow-lg p-4 p-md-5 rounded-5 bg-white">
      <form action="/listings/<%= listing._id %>?_method=PUT" method="POST"
            class="d-flex flex-column gap-5 needs-validation" novalidate>

       <section>
  <h6 class="section-title">1. Property Identity</h6>
  <div class="row g-3">
    <div class="col-md-12">
      <label for="title" class="form-label air-label">Property Title</label>
      <input id="title" name="listing[title]" type="text" class="form-control air-input" 
             value="<%= listing.title %>" placeholder="e.g. Modern Loft in the City Center" required>
      <div class="invalid-feedback">Please provide a catchy title.</div>
    </div>
<div class="row g-3">
  <div class="col-md-8">
    <label for="category" class="form-label air-label">Listing Type</label>
    <select name="listing[category]" id="category" class="form-select air-input" required onchange="updateCategoryHint()">
      <option value="" disabled <%= !listing.category ? 'selected' : '' %>>Choose a type...</option>
      <optgroup label="Stay Styles">
        <option value="Rooms" <%= listing.category === 'Rooms' ? 'selected' : '' %>>üõèÔ∏è Private Rooms</option>
        <option value="Hotels" <%= listing.category === 'Hotels' ? 'selected' : '' %>>üè® Boutique Hotels</option>
        <option value="Entire Home" <%= listing.category === 'Entire Home' ? 'selected' : '' %>>üè† Entire Home</option>
      </optgroup>
      <optgroup label="Nature & Unique">
        <option value="Cabins" <%= listing.category === 'Cabins' ? 'selected' : '' %>>üè° Cabins</option>
        <option value="Luxe" <%= listing.category === 'Luxe' ? 'selected' : '' %>>‚ú® Luxe</option>
      </optgroup>
    </select>
    <div id="category-hint" class="mt-2 p-2 rounded-3 bg-light border-start border-4 border-dark" style="font-size: 0.75rem; color: #555;">
      Select a type to see its definition.
    </div>
  </div>

  <% 
    // Ensuring we check both naming conventions to prevent "not defined" errors
    const activeUser = (typeof currUser !== 'undefined') ? currUser : (typeof currentUser !== 'undefined' ? currentUser : null); 
  %>

  <% if (activeUser && activeUser.role === "admin") { %>
    <div class="col-md-4">
      <label for="badgesCategory" class="form-label air-label">
        <i class="fa-solid fa-shield-check text-primary me-1"></i> Admin Badge
      </label>
      <select name="listing[badgesCategory]" id="badgesCategory" class="form-select air-input">
        <option value="" <%= (!listing || !listing.badgesCategory) ? 'selected' : '' %>>None</option>
        <% 
          const badges = ["Standard", "Premium", "Budget", "Luxury", "Trending", "Popular", "New", "Top Rated", "Featured", "Iconic"]; 
          badges.forEach(badge => { 
        %>
          <option value="<%= badge %>" <%= (listing && listing.badgesCategory === badge) ? 'selected' : '' %>>
            <%= badge %>
          </option>
        <% }) %>
      </select>
    </div>
  <% } else { %>
    <input type="hidden" name="listing[badgesCategory]" value="<%= (listing && listing.badgesCategory) ? listing.badgesCategory : 'Standard' %>">
  <% } %>
 <% if (activeUser && activeUser.role === "admin") { %>
  <div class="col-md-4">
    <label for="isVerified" class="form-label air-label">
      <i class="fa-solid fa-circle-check text-success me-1"></i> Verification Status
    </label>
    <select name="listing[isVerified]" id="isVerified" class="form-select air-input">
      <option value="false" <%= (listing && listing.isVerified === false) ? 'selected' : '' %>>
        Pending / Unverified
      </option>
      <option value="true" <%= (listing && listing.isVerified === true) ? 'selected' : '' %>>
        Verified / Live
      </option>
    </select>
  </div>
<% } else { %>
  <input type="hidden" name="listing[isVerified]" value="<%= (listing && listing.isVerified) ? 'true' : 'false' %>">
<% } %>
</div>
  </div>
</section>

        <section>
          <h6 class="section-title">2. Pricing & Capacity</h6>
          <div class="row g-4">
            <div class="col-md-4">
              <label for="price" class="form-label air-label">Nightly Rate</label>
              <div class="input-group">
                <span class="input-group-text bg-light border-end-0 air-input-group">‚Çπ</span>
                <input id="price" name="listing[price]" type="number" class="form-control air-input border-start-0" 
                       value="<%= listing.price %>" placeholder="0" required min="100">
              </div>
            </div>
            <div class="col-md-4">
              <label for="cleaningFee" class="form-label air-label">Cleaning Fee</label>
              <div class="input-group">
                <span class="input-group-text bg-light border-end-0 air-input-group">‚Çπ</span>
                <input id="cleaningFee" name="listing[cleaningFee]" type="number" class="form-control air-input border-start-0" 
                       value="<%= listing.cleaningFee || 0 %>">
              </div>
            </div>
            <div class="col-md-4">
              <label for="serviceFeePct" class="form-label air-label">Service Fee Percentage</label>
              <div class="input-group">
                <span class="input-group-text bg-light border-end-0 air-input-group">%</span>
                <input id="serviceFeePct" name="listing[serviceFeePct]" type="number" class="form-control air-input border-start-0" 
                       value="<%= listing.serviceFeePct || 3 %>" min="0" max="100">
              </div>

  <small class="text-muted" style="font-size: 0.7rem;">Calculated automatically based on Nightly Rate</small>

            </div>
            <div class="col-md-4">
              <label for="guests" class="form-label air-label">Max Guests</label>
              <input id="guests" name="listing[guests]" type="number" class="form-control air-input" 
                     value="<%= listing.guests || 1 %>" required min="1">
            </div>
          </div>
        </section>

       <section id="media-section">
  <h6 class="section-title">3. Media & Story</h6>
  
  <div class="mb-4">
    <label class="form-label air-label">Property Gallery (URLs)</label>
    <p class="text-muted extra-small mb-3" style="font-size: 0.65rem; letter-spacing: 1px;">
        PASTE A URL TO ADD MORE BOXES. CLEAR A BOX TO REMOVE IT.
    </p>
    
    <div id="image-input-container" class="d-flex flex-column gap-3">
      <% if (listing.image && listing.image.length > 0) { %>
        <% listing.image.forEach((img, index) => { %>
          <div class="image-group">
            <input name="listing[image][]" type="text" class="form-control air-input image-url-input" 
                   value="<%= img.url %>" placeholder="Paste high-quality image URL..." <%= index === 0 ? 'required' : '' %>>
          </div>
        <% }) %>
      <% } else { %>
        <div class="image-group">
          <input name="listing[image][]" type="text" class="form-control air-input image-url-input" 
                 placeholder="Paste high-quality image URL..." required>
        </div>
      <% } %>
    </div>
  </div>

  <div id="gallery-preview-grid" class="row row-cols-2 row-cols-md-4 g-3 mb-4"></div>

  <div>
    <label for="description" class="form-label air-label">About this place</label>
    <textarea 
        id="description" 
        name="listing[description]" 
        class="form-control air-input" 
        style="min-height:150px;" 
        required 
        minlength="10" 
        placeholder="Share what makes your place special..."
    ></textarea>
    <div class="invalid-feedback">
        Description must be at least 10 characters long.
    </div>
</div>
</section>

       <section>
  <h6 class="section-title">4. Location & Coordinates</h6>
  <div class="row g-3">
    <div class="col-md-8">
      <label for="location" class="form-label air-label">City/State</label>
      <input id="location" name="listing[location]" type="text" class="form-control air-input" 
             placeholder="e.g. Mumbai, Maharashtra" required 
             value="<%= (typeof listing !== 'undefined' && listing.location) ? listing.location : '' %>">
      <div class="invalid-feedback">Please provide a location.</div>
    </div>

    <div class="col-md-4">
      <label for="country" class="form-label air-label">Country</label>
      <input id="country" name="listing[country]" type="text" class="form-control air-input" 
             placeholder="India" required 
             value="<%= (typeof listing !== 'undefined' && listing.country) ? listing.country : 'India' %>">
    </div>

    <div class="col-md-6">
      <label for="lat" class="form-label air-label">
        <i class="fa-solid fa-location-crosshairs text-muted me-1"></i> Latitude
      </label>
      <input id="lat" name="listing[lat]" type="number" step="any" class="form-control air-input" 
             placeholder="e.g. 18.8797" 
             value="<%= (typeof listing !== 'undefined' && listing.lat) ? listing.lat : '18.8797' %>">
      <div class="form-text extra-small" style="color: #aaa;">Used for precise map placement</div>
    </div>

    <div class="col-md-6">
      <label for="lng" class="form-label air-label">
        <i class="fa-solid fa-location-crosshairs text-muted me-1"></i> Longitude
      </label>
      <input id="lng" name="listing[lng]" type="number" step="any" class="form-control air-input" 
             placeholder="e.g. 72.1402" 
             value="<%= (typeof listing !== 'undefined' && listing.lng) ? listing.lng : '72.1402' %>">
      <div class="form-text extra-small" style="color: #aaa;">Used for precise map placement</div>
    </div>
  </div>
</section>

        <section>
  <h6 class="section-title">5. Essentials & Features</h6>
  <div class="card border-0 bg-dark text-white rounded-5 p-4 shadow-sm">
    <p class="extra-small fw-bold mb-3" style="color: #aaa; letter-spacing: 1px; text-transform: uppercase;">Toggle Available Amenities</p>
    <div class="row g-4">
      <% 
        // Array matching your Mongoose Schema exactly
        const amenityKeys = ['wifi', 'ac', 'kitchen', 'parking', 'pool', 'gym', 'workspacer', 'pets', 'cctv']; 
      %>
      
      <% amenityKeys.forEach(key => { %>
        <div class="col-6 col-md-4">
          <div class="form-check form-switch custom-switch">
            <input class="form-check-input" type="checkbox" role="switch" 
                   name="listing[amenities][<%= key %>]" 
                   id="<%= key %>" 
                   <%# This line checks the existing values for Edit mode #%>
                   <%= (typeof listing !== 'undefined' && listing.amenities && listing.amenities[key]) ? 'checked' : '' %>>
            
            <label class="form-check-label small text-white-50" for="<%= key %>">
              <% if(key === 'wifi') { %> Fast Wi-Fi 
              <% } else if(key === 'workspacer') { %> Workspace
              <% } else if(key === 'ac') { %> AC
              <% } else { %> <%= key.charAt(0).toUpperCase() + key.slice(1) %> <% } %>
            </label>
          </div>
        </div>
      <% }) %>
    </div>
  </div>
</section>

        <div class="d-flex flex-column flex-md-row gap-3 pt-5 border-top">
          <a href="/listings/<%= listing._id %>" class="btn btn-outline-dark px-5 py-3 rounded-pill fw-bold order-2 order-md-1">Cancel</a>
          <button type="submit" id="submitBtn" class="btn btn-launch flex-grow-1 py-3 rounded-pill fw-bold shadow-sm order-1 order-md-2">
  <span id="btnText">Update My Listing</span>
  <span id="btnSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
</button>
        </div>

      </form>
    </div>
  </div>
</div>

<style>
  :root {
    --air-red: #ff385c;
    --air-black: #222222;
  }

  .listing-form-wrapper { background: linear-gradient(180deg, #ffffff 0%, #f7f7f7 100%); min-height: 100vh; }
  .rounded-5 { border-radius: 1.5rem !important; }

  .section-title { 
    font-weight: 800; text-transform: uppercase; color: #b0b0b0; font-size: 0.7rem; 
    letter-spacing: 2px; margin-bottom: 1.75rem; display: flex; align-items: center; gap: 15px; 
  }
  .section-title::after { content: ""; height: 1px; flex-grow: 1; background: #e0e0e0; }

  .air-label { font-size: 0.88rem; color: #222; margin-bottom: 8px; font-weight: 600 !important; display: block; }
  .extra-small { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 1.5px; }

  .air-input { 
    border-radius: 12px !important; padding: 12px 18px; border: 1px solid #b0b0b0; 
    background: #fff; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); font-size: 0.95rem;
  }
  .air-input:focus { border-color: var(--air-black); box-shadow: 0 0 0 1px var(--air-black); outline: none; }

  .air-input-group { border-radius: 12px 0 0 12px !important; border: 1px solid #b0b0b0; background-color: #f8f9fa; font-weight: bold; }

  .custom-switch .form-check-input { width: 2.8em !important; height: 1.4em !important; cursor: pointer; }
  .custom-switch .form-check-input:checked { background-color: var(--air-red); border-color: var(--air-red); }

  .btn-launch { 
    background: radial-gradient(circle at center, #FF385C 0%, #E61E4D 100%);
    color: #fff; border: none; transition: all 0.4s ease;
  }
  .btn-launch:hover { transform: scale(1.01); box-shadow: 0 10px 20px rgba(230, 30, 77, 0.25); color: #fff; filter: brightness(1.1); }

  #image-preview-container { border: 2px dashed #ddd; background: #fafafa; }

  .was-validated .form-control:invalid { border-color: #c13515 !important; }
  .was-validated .form-control:valid { border-color: #008a05 !important; }
  .custom-switch label { padding: 4px; }
  .input-group input{ 
    border-top-left-radius: 0px !important;
    border-bottom-left-radius: 0 !important;
}


.gallery-preview-card {
    position: relative;
    aspect-ratio: 3 / 2;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid #eeeeee;
    background: #f8f9fa;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

.preview-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.4s ease;
}

.preview-index {
    position: absolute;
    top: 8px;
    left: 8px;
    background: rgba(255, 255, 255, 0.9);
    color: #222;
    font-size: 10px;
    font-weight: 800;
    padding: 2px 6px;
    border-radius: 4px;
    z-index: 5;
}

.animate-in {
    animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>

<script>
  // 1. Category Definitions
  const categoryHints = {
    "Rooms": "A private room in a home, plus access to shared spaces.",
    "Hotels": "A professional hospitality stay, including boutique hotels or hostels.",
    "Entire Home": "Guests have the whole place to themselves. Usually includes a kitchen.",
    "Cabins": "Secluded, rustic homes usually located in woods or rural areas.",
    "Luxe": "High-end architecture, premium amenities, and top-tier service.",
    "Trending": "Properties with unique design or high demand this season."
  };

  // 2. Global Category Hint Function (needed for the onchange attribute in HTML)
  function updateCategoryHint() {
    const select = document.getElementById('category');
    const hintDiv = document.getElementById('category-hint');
    if (hintDiv && select && categoryHints[select.value]) {
      hintDiv.innerHTML = `<strong>Definition:</strong> ${categoryHints[select.value]}`;
    }
  }

  // 3. Main Logic Wrapper
  (() => {
    'use strict'

    // Element Selection
    const form = document.querySelector('.needs-validation');
    const submitBtn = document.getElementById('submitBtn');
    const btnText = document.getElementById('btnText');
    const btnSpinner = document.getElementById('btnSpinner');
    const imgInput = document.getElementById('image');
    const preview = document.getElementById('image-preview');
    const previewContainer = document.getElementById('image-preview-container');
    const priceInput = document.getElementById('price');
    const serviceFeeInput = document.getElementById('serviceFee'); // Your specific fee field
    const SERVICE_FEE_PCT = 0.03; // 3% Platform Fee

    // --- FEE CALCULATION LOGIC ---
    const calculateFees = () => {
      if (priceInput && serviceFeeInput) {
        const price = parseFloat(priceInput.value) || 0;
        const calculatedFee = Math.round(price * SERVICE_FEE_PCT);
        serviceFeeInput.value = calculatedFee;
      }
    };

    // --- IMAGE PREVIEW LOGIC ---
    const updatePreview = () => {
      if (imgInput && preview && previewContainer) {
        const url = imgInput.value.trim();
        if (url !== "") {
          preview.src = url;
          previewContainer.classList.remove('d-none');
        } else {
          previewContainer.classList.add('d-none');
        }
      }
    };

    // --- FORM SUBMISSION & VALIDATION LOGIC ---
    if (form) {
      form.addEventListener('submit', event => {
        if (!form.checkValidity()) {
          event.preventDefault();
          event.stopPropagation();
          
          form.classList.add('was-validated');

          // Smooth scroll to first error
          const firstInvalid = form.querySelector(':invalid');
          if (firstInvalid) {
            firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        } else {
          // Valid form: Handle Loading State
          if (submitBtn) {
            submitBtn.disabled = true; 
            if (btnText) btnText.innerText = "Updating...";
            if (btnSpinner) btnSpinner.classList.remove('d-none');
          }
          // Form proceeds to submit normally
        }
      }, false);
    }

    // --- EVENT LISTENERS & INITIALIZATION ---
    imgInput?.addEventListener('input', updatePreview);
    priceInput?.addEventListener('input', calculateFees);

    window.addEventListener('DOMContentLoaded', () => {
      updateCategoryHint();
      updatePreview();
      calculateFees();
    });

    // Fallback for window load to ensure initial calculations
    window.addEventListener('load', () => {
      updatePreview();
      calculateFees();
    });

  })();


  document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById('image-input-container');
    const grid = document.getElementById('gallery-preview-grid');

    function updateGallery() {
        const inputs = document.querySelectorAll('.image-url-input');
        grid.innerHTML = ''; // Clear current previews

        inputs.forEach((input, index) => {
            const url = input.value.trim();
            
            // 1. Render Preview if URL exists
            if (url) {
                const col = document.createElement('div');
                col.className = 'col animate-in';
                col.innerHTML = `
                    <div class="gallery-preview-card">
                        <span class="preview-index">#${index + 1}</span>
                        <img src="${url}" class="preview-img" onerror="this.src='https://via.placeholder.com/300x200?text=Invalid+URL'">
                    </div>
                `;
                grid.appendChild(col);
            }

            // 2. Logic to add/remove input boxes
            // If the last input has text, add a new empty one
            if (index === inputs.length - 1 && url !== "") {
                const newGroup = document.createElement('div');
                newGroup.className = 'image-group animate-in mt-2';
                newGroup.innerHTML = `<input name="listing[image][]" type="text" class="form-control air-input image-url-input" placeholder="Add another image URL...">`;
                container.appendChild(newGroup);
                // Attach listener to the new input
                newGroup.querySelector('input').addEventListener('input', updateGallery);
            }

            // If an input is empty and it's NOT the last one, remove it
            if (url === "" && inputs.length > 1 && index !== inputs.length - 1) {
                input.parentElement.remove();
                updateGallery();
            }
        });
    }

    // Initial listener for existing inputs
    container.addEventListener('input', (e) => {
        if (e.target.classList.contains('image-url-input')) {
            updateGallery();
        }
    });

    // Run once on load to show existing images
    updateGallery();
});
</script>





<script>
(() => {
  'use strict'
  const forms = document.querySelectorAll('.needs-validation')
  Array.from(forms).forEach(form => {
    form.addEventListener('submit', event => {
      if (!form.checkValidity()) {
        event.preventDefault()
        event.stopPropagation()
      }
      form.classList.add('was-validated')
    }, false)
  })
})()
</script>