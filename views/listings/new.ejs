<% layout('layouts/boilerplate') %>

<div class="listing-form-wrapper py-5">
  <div class="container" style="max-width: 850px;">
    
    <div class="mb-5 d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-3">
        <a href="/listings<%= isEdit ? '/' + listing._id : '' %>" class="btn btn-outline-dark rounded-circle d-flex align-items-center justify-content-center shadow-sm" style="width:45px; height:45px;">
          <span class="material-symbols-outlined">arrow_back</span>
        </a>
        <div>
          <h2 class="fw-bold mb-0"><%= isEdit ? 'Edit Your Space' : 'List Your Space' %></h2>
          <p class="text-muted small mb-0">Property ID: <%= isEdit ? '#' + listing._id.toString().slice(-6).toUpperCase() : 'New Listing' %></p>
        </div>
      </div>
      <span class="badge bg-white text-dark border px-3 py-2 rounded-pill shadow-sm">
        <i class="fa-solid fa-circle-check text-success me-1"></i> Details Verification
      </span>
    </div>

    <div class="card border-0 shadow-lg p-4 p-md-5 rounded-5 bg-white">
      <form action="<%= isEdit ? `/listings/${listing._id}?_method=PUT` : '/listings/createListing' %>" method="POST"
            class="d-flex flex-column gap-5 needs-validation" novalidate>

        <section>
          <h6 class="section-title">1. Property Identity</h6>
          <div class="row g-3">
            <div class="col-md-8">
              <label for="title" class="form-label air-label">Property Title</label>
              <input id="title" name="listing[title]" type="text" class="form-control air-input" 
                     value="<%= listing?.title || '' %>" placeholder="e.g. Modern Loft in the City Center" required>
              <div class="invalid-feedback">Please provide a catchy title.</div>
            </div>
            <div class="col-md-4">
              <label for="category" class="form-label air-label">Category</label>
              <select name="listing[category]" id="category" class="form-select air-input">
                <% ['Standard', 'Premium', 'Trending', 'Iconic'].forEach(cat => { %>
                  <option value="<%= cat %>" <%= listing?.category === cat ? 'selected' : '' %>><%= cat %></option>
                <% }) %>
              </select>
            </div>
          </div>
        </section>

        <section>
          <h6 class="section-title">2. Pricing & Capacity</h6>
          <div class="row g-4">
            <div class="col-md-4">
              <label for="price" class="form-label air-label">Nightly Rate</label>
              <div class="input-group">
                <span class="input-group-text bg-light border-end-0 air-input-group">₹</span>
                <input id="price" name="listing[price]" type="number" class="form-control air-input border-start-0" 
                       value="<%= listing?.price || '' %>" placeholder="0" required min="100">
              </div>
            </div>
            <div class="col-md-4">
              <label for="cleaningFee" class="form-label air-label">Cleaning Fee</label>
              <div class="input-group">
                <span class="input-group-text bg-light border-end-0 air-input-group">₹</span>
                <input id="cleaningFee" name="listing[cleaningFee]" type="number" class="form-control air-input border-start-0" 
                       value="<%= listing?.cleaningFee || 0 %>">
              </div>
            </div>
            <div class="col-md-4">
              <label for="guests" class="form-label air-label">Max Guests</label>
              <input id="guests" name="listing[guests]" type="number" class="form-control air-input" 
                     value="<%= listing?.guests || 1 %>" required min="1">
            </div>
          </div>
        </section>

        <section>
          <h6 class="section-title">3. Media & Story</h6>
          <div class="mb-4">
            <label for="image" class="form-label air-label">Cover Image URL</label>
            <input id="image" name="listing[image][url]" type="text" class="form-control air-input" 
                   value="<%= listing?.image?.url || '' %>" placeholder="Paste high-quality image URL..." required>
            
            <div id="image-preview-container" class="mt-3 rounded-4 overflow-hidden border d-none position-relative" style="height: 250px;">
                <img id="image-preview" src="" class="w-100 h-100 object-fit-cover" alt="Preview">
                <div class="position-absolute bottom-0 start-0 w-100 p-2 bg-dark bg-opacity-50 text-white small text-center">Live Preview</div>
            </div>
          </div>
          <div>
            <label for="description" class="form-label air-label">About the space</label>
            <textarea id="description" name="listing[description]" class="form-control air-input" 
                      style="min-height:150px;" required placeholder="Share what makes your place special..."><%= listing?.description || '' %></textarea>
          </div>
        </section>

        <section>
          <h6 class="section-title">4. Location Details</h6>
          <div class="row g-3">
            <div class="col-md-8">
              <label for="location" class="form-label air-label">City/State</label>
              <input id="location" name="listing[location]" type="text" class="form-control air-input" 
                     value="<%= listing?.location || '' %>" placeholder="e.g. Mumbai, Maharashtra" required>
            </div>
            <div class="col-md-4">
              <label for="country" class="form-label air-label">Country</label>
              <input id="country" name="listing[country]" type="text" class="form-control air-input" 
                     value="<%= listing?.country || '' %>" placeholder="India" required>
            </div>
          </div>
        </section>

        <section>
          <h6 class="section-title">5. Essentials & Features</h6>
          <div class="card border-0 bg-dark text-white rounded-5 p-4 shadow-sm">
            <p class="extra-small fw-bold mb-3" style="color: #aaa; letter-spacing: 1px;">Toggle Available Amenities</p>
            <div class="row g-4">
              <% const amenityKeys = ['wifi', 'ac', 'pool', 'kitchen', 'parking', 'gym']; %>
              <% amenityKeys.forEach(key => { %>
                <div class="col-6 col-md-4">
                  <div class="form-check form-switch custom-switch">
                    <input class="form-check-input" type="checkbox" role="switch" name="listing[amenities][<%= key %>]" 
                           id="<%= key %>" <%= listing?.amenities?.[key] ? 'checked' : '' %>>
                    <label class="form-check-label small text-white-50" for="<%= key %>">
                      <%= key === 'wifi' ? 'Fast Wi-Fi' : key.toUpperCase() %>
                    </label>
                  </div>
                </div>
              <% }) %>
            </div>
          </div>
        </section>

        <div class="d-flex flex-column flex-md-row gap-3 pt-5 border-top">
          <a href="/listings<%= isEdit ? '/' + listing._id : '' %>" class="btn btn-outline-dark px-5 py-3 rounded-pill fw-bold order-2 order-md-1">Cancel</a>
          <button type="submit" class="btn btn-launch flex-grow-1 py-3 rounded-pill fw-bold shadow-sm order-1 order-md-2">
            <%= isEdit ? 'Update My Listing' : 'Launch My Listing' %>
          </button>
        </div>

      </form>
    </div>
  </div>
</div>

<style>
  :root {
    --air-red: #ff385c;
    --air-black: #222222;
  }

  .listing-form-wrapper { background: linear-gradient(180deg, #ffffff 0%, #f7f7f7 100%); min-height: 100vh; }
  .rounded-5 { border-radius: 1.5rem !important; }

  /* Section Headers with Line Decoration */
  .section-title { 
    font-weight: 800; text-transform: uppercase; color: #b0b0b0; font-size: 0.7rem; 
    letter-spacing: 2px; margin-bottom: 1.75rem; display: flex; align-items: center; gap: 15px; 
  }
  .section-title::after { content: ""; height: 1px; flex-grow: 1; background: #e0e0e0; }

  .air-label { font-size: 0.88rem; color: #222; margin-bottom: 8px; font-weight: 600 !important; display: block; }
  .extra-small { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 1.5px; }

  /* Premium Inputs */
  .air-input { 
    border-radius: 12px !important; padding: 12px 18px; border: 1px solid #b0b0b0; 
    background: #fff; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); font-size: 0.95rem;
  }
  .air-input:focus { border-color: var(--air-black); box-shadow: 0 0 0 1px var(--air-black); outline: none; }

  .air-input-group { border-radius: 12px 0 0 12px !important; border: 1px solid #b0b0b0; background-color: #f8f9fa; font-weight: bold; }

  /* Switches */
  .custom-switch .form-check-input { width: 2.8em !important; height: 1.4em !important; cursor: pointer; }
  .custom-switch .form-check-input:checked { background-color: var(--air-red); border-color: var(--air-red); }

  /* Launch Button */
  .btn-launch { 
    background: radial-gradient(circle at center, #FF385C 0%, #E61E4D 100%);
    color: #fff; border: none; transition: all 0.4s ease;
  }
  .btn-launch:hover { transform: scale(1.01); box-shadow: 0 10px 20px rgba(230, 30, 77, 0.25); color: #fff; filter: brightness(1.1); }

  /* Preview Container */
  #image-preview-container { border: 2px dashed #ddd; background: #fafafa; }

  .was-validated .form-control:invalid { border-color: #c13515 !important; }
  .was-validated .form-control:valid { border-color: #008a05 !important; }
</style>

<script>
  (() => {
    'use strict'
    const imgInput = document.getElementById('image');
    const preview = document.getElementById('image-preview');
    const previewContainer = document.getElementById('image-preview-container');

    // Live Image Preview Function
    const updatePreview = () => {
      const url = imgInput.value.trim();
      if(url !== "") {
        preview.src = url;
        previewContainer.classList.remove('d-none');
      } else {
        previewContainer.classList.add('d-none');
      }
    }

    // Event Listeners for Preview
    imgInput.addEventListener('input', updatePreview);
    window.addEventListener('load', updatePreview);

    // Bootstrap Validation
    const forms = document.querySelectorAll('.needs-validation')
    Array.from(forms).forEach(form => {
      form.addEventListener('submit', event => {
        if (!form.checkValidity()) {
          event.preventDefault()
          event.stopPropagation()
        }
        form.classList.add('was-validated')
      }, false)
    })
  })()
</script>