<% layout("layouts/boilerplate") %>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<div id="customConfirmModal" class="custom-modal-overlay" style="display: none;">
    <div class="custom-modal-card">
        <div class="modal-body-content text-center p-4">
            <div class="confirm-icon mb-3">
                <span class="material-symbols-outlined text-danger" style="font-size: 48px;">bedtime</span>
            </div>
            <h4 class="fw-bold mb-3">Confirm Reservation</h4>
            <div id="confirmDetails" class="text-start bg-light p-3 rounded-4 mb-4 small"></div>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-light w-100 rounded-pill fw-bold" onclick="closeConfirmModal()">Cancel</button>
                <button type="button" class="btn btn-air-primary w-100 rounded-pill fw-bold" onclick="finalSubmit(event)">Confirm</button>
            </div>
        </div>
    </div>
</div>

<div id="priceBreakdownModal" class="custom-modal-overlay" style="display: none;">
    <div class="custom-modal-card">
        <div class="modal-body-content p-4">
            <h4 class="fw-bold mb-4 text-center">Price breakdown</h4>
            <div class="price-details">
                <div class="d-flex justify-content-between mb-2">
                    <span id="modalBaseCalc">₹ <%= listing.price.toLocaleString("en-IN") %> x 0 days</span>
                    <span id="modalBaseTotal">₹ 0</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-decoration-underline">Cleaning fee</span>
                    <span>₹ <%= listing.cleaningFee || 0 %></span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-decoration-underline">Service fee (<%= listing.serviceFeePct || 0 %>%)</span>
                    <span id="modalServiceFee">₹ 0</span>
                </div>
                <div class="d-flex justify-content-between mb-3 text-danger fw-bold">
                    <span>GST (18%)</span>
                    <span id="modalGstAmount">₹ 0</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between fw-bold fs-5 mt-3">
                    <span>Total (INR)</span>
                    <span id="modalFinalTotal" class="text-dark">₹ 0</span>
                </div>
            </div>
            <button type="button" class="btn btn-air-primary w-100 rounded-pill fw-bold mt-4 py-3" onclick="closePriceModal()">Close</button>
        </div>
    </div>
</div>
<div id="deleteConfirmModal" class="custom-modal-overlay" style="display: none;">
    <div class="custom-modal-card">
        <div class="modal-body-content text-center p-4">
            <div class="confirm-icon mb-3">
                <span class="material-symbols-outlined text-danger" style="font-size: 56px; font-variation-settings: 'FILL' 1;">warning</span>
            </div>
            <h4 class="fw-bold mb-2">Delete Review?</h4>
            <p class="text-muted small mb-4">This action cannot be undone. Are you sure you want to remove this feedback?</p>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-light w-100 rounded-pill fw-bold" onclick="closeDeleteModal()">Cancel</button>
                <button type="button" id="finalDeleteBtn" class="btn btn-air-danger-filled w-100 rounded-pill fw-bold">Delete</button>
            </div>
        </div>
    </div>
</div>

<div class="container show-container mt-5">
  <div class="row">
    <div class="col-12 mb-3">
      <h2 class="fw-bold"><%= listing.title %></h2>
      <div class="d-flex justify-content-between align-items-center">
        <p class="text-muted mb-0">
          <span class="material-symbols-outlined fs-6 align-middle">location_on</span>
          <%= listing.location %>, <%= listing.country %>
        </p>
        
        <% if (currentUser && (currentUser.role === "admin" || (listing.owner && currentUser._id.toString() === listing.owner._id.toString()))) { %>
          <div class="d-flex gap-2">
            <a href="/listings/<%= listing._id %>/edit" class="btn btn-air-secondary btn-sm px-3">
              <span class="material-symbols-outlined fs-6 align-middle me-1">edit</span> Edit
            </a>
            <form action="/listings/<%= listing._id %>?_method=DELETE" method="POST" id="listing-delete-form">
  <button type="button" class="btn btn-air-danger btn-sm px-3" onclick="openListingDeleteModal()">
    <span class="material-symbols-outlined fs-6 align-middle me-1">delete</span> Delete
  </button>
</form>
          </div>
        <% } %>
      </div>
    </div>

   <div class="col-12 mb-4">
  <div id="listingCarousel" class="carousel slide shadow-sm rounded-4 overflow-hidden" data-bs-ride="carousel">
    <div class="carousel-indicators">
      <% listing.image.forEach((img, index) => { %>
        <button type="button" data-bs-target="#listingCarousel" data-bs-slide-to="<%= index %>" class="<%= index === 0 ? 'active' : '' %>" aria-current="<%= index === 0 ? 'true' : 'false' %>"></button>
      <% }) %>
    </div>

    <div class="carousel-inner">
  <% if (listing.image && listing.image.length > 0) { %>
    <% listing.image.forEach((img, index) => { %>
      <div class="carousel-item <%= index === 0 ? 'active' : '' %> position-relative">
        <img src="<%= img.url %>" class="d-block w-100 show-img" alt="Image <%= index + 1 %>">
        
        <button type="button" 
                class="btn btn-light btn-sm position-absolute bottom-0 end-0 m-3 rounded-circle shadow-sm d-flex align-items-center justify-content-center zoom-trigger" 
                onclick="openLightbox(<%= index %>)" 
                style="width: 42px; height: 42px; z-index: 10; opacity: 0.9; border: 1px solid #ddd;">
            <span class="material-symbols-outlined" style="font-size: 22px; color: #222;">zoom_in</span>
        </button>
      </div>
    <% }) %>
  <% } %>
</div>

    <% if (listing.image && listing.image.length > 1) { %>
      <button class="carousel-control-prev" type="button" data-bs-target="#listingCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Previous</span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#listingCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Next</span>
      </button>
    <% } %>

    <% if (listing.price > 10000) { %>
      <div class="premium-badge" style="z-index: 5;">Premium Stay</div>
    <% } %>
  </div>
  
</div>

    <div class="col-lg-7">
      <div class="details-card p-4 rounded-4 shadow-sm border mb-4">
        <div class="d-flex align-items-center mb-4 pb-3 border-bottom">
          <div class="owner-avatar me-3">
            <%= listing.owner ? listing.owner.username.charAt(0).toUpperCase() : 'O' %>
          </div>
          <div>
            <h5 class="mb-0 fw-bold">Hosted by <%= listing.owner ? listing.owner.username : "Professional Host" %></h5>
            <p class="text-muted small mb-0">Member since 2026</p>
          </div>
        </div>
        <h5 class="fw-bold mb-3">About this place</h5>
        <p class="listing-desc text-secondary"><%= listing.description %></p>
      </div>

      <div class="amenities-section mb-5 p-2">
        <h5 class="fw-bold mb-4">What this place offers</h5>
        <div class="row g-3">
          <div class="col-6 mb-2 amenity-item"><span class="material-symbols-outlined">cooking</span> Kitchen</div>
          <div class="col-6 mb-2 amenity-item"><span class="material-symbols-outlined">wifi</span> Wifi</div>
          <div class="col-6 mb-2 amenity-item"><span class="material-symbols-outlined">laptop_mac</span> Dedicated workspace</div>
          <div class="col-6 mb-2 amenity-item"><span class="material-symbols-outlined">elevator</span> Lift</div>
          <div class="col-6 mb-2 amenity-item"><span class="material-symbols-outlined">ac_unit</span> Air conditioning</div>
          <div class="col-6 mb-2 amenity-item"><span class="material-symbols-outlined">air_freshener</span> Hair dryer</div>
          <div class="col-6 mb-2 amenity-item"><span class="material-symbols-outlined">kitchen</span> Fridge</div>
          <div class="col-6 mb-2 amenity-item"><span class="material-symbols-outlined">microwave</span> Microwave</div>
          <div class="col-6 mb-2 amenity-item"><span class="material-symbols-outlined">smoking_rooms</span> Smoking allowed</div>
          <div class="col-6 mb-2 amenity-item"><span class="material-symbols-outlined">calendar_today</span> Long-term stays allowed</div>
        </div>
      </div>
    </div>

    <div class="col-lg-5">
      <div class="reservation-card p-4 rounded-4 shadow border bg-white mb-4 sticky-top" style="top: 100px; z-index: 10;">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="mb-0 fw-bold">₹ <%= listing.price.toLocaleString("en-IN") %> <small class="fw-light text-muted">/ daily</small></h4>
          <a href="javascript:void(0)" onclick="openPriceModal()" class="text-muted small text-decoration-underline">Show price breakdown</a>
        </div>
        
        <form action="/listings/<%= listing._id %>/reserve" method="POST" id="reservationForm">
          <div class="reservation-dates border rounded-3 overflow-hidden mb-3">
            <div class="row g-0 border-bottom">
              <div class="col-6 border-end p-2">
                <label class="small fw-bold d-block">Check-in</label>
                <input type="date" name="reservation[checkIn]" id="checkIn" class="date-input-flat w-100 border-0" required value="2026-02-20">
              </div>
              <div class="col-6 p-2">
                <label class="small fw-bold d-block">Checkout</label>
                <input type="date" name="reservation[checkOut]" id="checkOut" class="date-input-flat w-100 border-0" required value="2026-02-22">
              </div>
            </div>

            <div class="row g-0 p-2">
              <div class="col-6 border-end px-2">
                <label class="fw-bold d-block" style="font-size: 11px; text-transform: uppercase;">Adults (13+)</label>
                <div class="d-flex align-items-center justify-content-between">
                  <input type="number" id="adults" name="reservation[adults]" 
                         class="form-control form-control-sm border-0 p-0 shadow-none bg-transparent" 
                         value="1" min="1" max="15">
                  <div class="d-flex flex-column controls">
                    <span class="material-symbols-outlined clickable" onclick="changeVal('adults', 1)">keyboard_arrow_up</span>
                    <span class="material-symbols-outlined clickable" onclick="changeVal('adults', -1)">keyboard_arrow_down</span>
                  </div>
                </div>
              </div>
              
              <div class="col-6 px-2">
                <label class="fw-bold d-block" style="font-size: 11px; text-transform: uppercase;">Children (2-12)</label>
                <div class="d-flex align-items-center justify-content-between">
                  <input type="number" id="children" name="reservation[children]" 
                         class="form-control form-control-sm border-0 p-0 shadow-none bg-transparent" 
                         value="0" min="0" max="10">
                  <div class="d-flex flex-column controls">
                    <span class="material-symbols-outlined clickable" onclick="changeVal('children', 1)">keyboard_arrow_up</span>
                    <span class="material-symbols-outlined clickable" onclick="changeVal('children', -1)">keyboard_arrow_down</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <input type="hidden" name="reservation[price]" value="<%= listing.price %>">
          <input type="hidden" name="reservation[totalPrice]" id="hiddenFinalTotal" value="0">

          <button type="button" onclick="<%= currentUser ? 'handleReservation()' : "window.location.href='/login'" %>"
                  class="btn btn-air-primary w-100 py-3 fw-bold mb-3">
            Reserve
          </button>
        </form>

        <p class="text-center small text-muted mb-0">You won't be charged yet</p>
        
        <div class="mt-4 p-3 border rounded-3 bg-light-subtle d-flex align-items-center">
          <span class="material-symbols-outlined text-danger me-2">cancel</span>
          <p class="small mb-0 fw-semibold">Free cancellation before <span id="cancel-deadline">6 hours of booking</span></p>
        </div>
      </div>
    </div>

    <hr class="my-5">
    <div class="col-12 mb-5">
      <div class="row">
       <div class="col-lg-4 mb-4">
    <div class="p-4 rounded-4 border bg-white shadow-sm">
        <h5 class="fw-bold mb-3">Leave a Review</h5>
        <form action="/listings/<%= listing._id %>/reviews" method="POST" id="reviewForm" class="needs-validation" novalidate>
            <div class="star-rating d-flex flex-row-reverse justify-content-end mb-3">
                <% [5,4,3,2,1].forEach(num => { %>
                    <input type="radio" name="rating" value="<%= num %>" id="rate<%= num %>" required>
                    <label for="rate<%= num %>"><span class="material-symbols-outlined">star</span></label>
                <% }) %>
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-semibold">Your Comment</label>
                <textarea name="comment" rows="4" class="form-control rounded-3" placeholder="How was your experience?" required></textarea>
                <div class="invalid-feedback">Please share a few words about your stay.</div>
            </div>

            <button type="button" onclick="submitReview(event)" class="btn btn-air-primary w-100 py-2 fw-bold">
                Submit Review
            </button>
        </form>
    </div>
</div>

        <div class="col-lg-8">
  <h5 class="fw-bold mb-4">Guest Reviews</h5>
  <div class="reviews-scroll-container custom-scrollbar pe-2" style="max-height: 400px; overflow-y: auto;">
    <div class="row row-cols-1 row-cols-md-2 g-3">
      <% if (listing.reviews && listing.reviews.length > 0) { %>
        <% listing.reviews.forEach(review => { %>
          <div class="col">
            <div class="review-card p-3 rounded-4 border h-100 bg-white shadow-sm d-flex flex-column justify-content-between">
              <div>
                <div class="d-flex align-items-center mb-3">
                  <div class="author-img-container me-3">
                    <% if (review.author && review.author.image && review.author.image.url) { %>
                      <img src="<%= review.author.image.url %>" class="author-pfp" alt="profile">
                    <% } else { %>
                      <div class="author-letter-badge">
                        <%= review.author ? review.author.username.charAt(0).toUpperCase() : 'A' %>
                      </div>
                    <% } %>
                  </div>
                  <div class="flex-grow-1">
                    <div class="fw-bold small text-dark"><%= review.author ? review.author.username : "Anonymous" %></div>
                    <div class="d-flex align-items-center">
                      <span class="material-symbols-outlined fs-6 text-warning me-1" style="font-variation-settings: 'FILL' 1;">star</span>
                      <span class="small fw-bold"><%= review.rating %></span>
                    </div>
                  </div>
                   <% if (currentUser && review.author && (currentUser._id.toString() === review.author._id.toString() || currentUser.role === 'admin')) { %>
                <div class="mt-2 text-end">
                  <form action="/reviews/<%= review._id %>?_method=DELETE" method="POST" id="delete-form-<%= review._id %>" class="d-inline">
                    <button type="button" 
        class="btn btn-sm btn-air-danger px-2 py-1" 
        onclick="openDeleteModal('<%= review._id %>')" 
        style="border: none; background: transparent; color: #ff385c;">
  <span class="material-symbols-outlined fs-5 align-middle">delete</span>
</button>
                  </form>
                </div>
              <% } %>
                </div>
                <p class="small text-muted mb-2"><%= review.comment %></p>
              </div>

             
            </div>
          </div>
        <% }) %>
      <% } else { %>
        <div class="col-12"><p class="text-muted">No reviews yet. Be the first!</p></div>
      <% } %>
    </div>
  </div>
</div>
      </div>
    </div>

    <% if (listing.lat && listing.lng) { %>
      <div class="col-12 mb-5">
        <h5 class="fw-bold mb-3">Where you'll be</h5>
        <div id="map" class="rounded-4 shadow-sm border w-100" style="height: 450px;"></div>
      </div>
    <% } %>
  </div>
</div>

<div class="modal fade" id="imageLightbox" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content border-0 bg-transparent">
            <div class="modal-body p-0 position-relative d-flex align-items-center justify-content-center">
                
                <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" data-bs-dismiss="modal" aria-label="Close" style="z-index: 1100;"></button>
                
                <div id="lightboxCounter" class="position-absolute top-0 start-0 m-3 text-white small fw-bold" style="z-index: 1100; background: rgba(0,0,0,0.4); padding: 5px 12px; border-radius: 20px;"></div>

                <button class="lightbox-nav-btn prev" onclick="changeLightboxImg(-1)">
                    <span class="material-symbols-outlined">chevron_left</span>
                </button>

                <img src="" id="lightboxImg" class="img-fluid rounded-4 shadow-lg">

                <button class="lightbox-nav-btn next" onclick="changeLightboxImg(1)">
                    <span class="material-symbols-outlined">chevron_right</span>
                </button>
                
            </div>
        </div>
    </div>
</div>

<style>
  /* Reuse Modal Styles */
  .custom-modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
    display: flex; align-items: center; justify-content: center; z-index: 9999;
  }
  .custom-modal-card {
    background: white; width: 90%; max-width: 400px;
    border-radius: 2rem; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    animation: slideUp 0.3s ease-out;
  }
  @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

  /* Page Styles - Kept Exact */
  .show-container { max-width: 1100px; margin: auto; }
  .btn-air-primary { background: #ff385c; color: white; border: none; transition: 0.3s; }
  .btn-air-primary:hover { background: #e31c5f; transform: scale(1.02); }
  .btn-air-secondary { background: #f8f9fa; border: 1px solid #ddd; color: #222; }
  .btn-air-danger { background: #fff; border: 1px solid #ff385c; color: #ff385c; }
  .show-img { width: 100%; max-height: 500px; object-fit: cover; border-radius: 1.5rem; }
  .owner-avatar { width: 45px; height: 45px; background: #222; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
  .premium-badge { position: absolute; top: 20px; left: 20px; background: rgba(255,255,255,0.9); padding: 5px 15px; border-radius: 50px; font-weight: 800; font-size: 0.7rem; text-transform: uppercase; }
  .amenity-item { display: flex; align-items: center; }
  .amenity-item span { margin-right: 12px; font-size: 24px; color: #484848; }
  .reservation-card { box-shadow: 0 6px 16px rgba(0,0,0,0.12) !important; border-radius: 1.5rem; }
  .date-input-flat { border: none; background: transparent; font-size: 0.85rem; color: #717171; outline: none; cursor: pointer; }
  .author-letter-badge { width: 40px; height: 40px; background: #e7e4e4; color: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; }
  .star-rating input { display: none; }
  .star-rating label { color: #ddd; cursor: pointer; transition: 0.2s; font-size: 28px; }
  .star-rating label:hover, .star-rating label:hover ~ label, .star-rating input:checked ~ label { color: #ff385c; font-variation-settings: 'FILL' 1; }
  .controls { user-select: none; line-height: 0.8; }
  .clickable { font-size: 18px !important; cursor: pointer; color: #717171; transition: 0.2s; }
  .clickable:hover { color: #ff385c; }
  #map { z-index: 1; display: block; }

  /* Price Details Styling */
  .price-details span { color: #222; font-size: 1rem; }
  .price-details hr { border-top: 1px solid #ddd; margin: 1.5rem 0; }
  .btn-air-danger-filled {
    background: #ff385c;
    color: white;
    border: none;
    transition: 0.2s ease;
}
.btn-air-danger-filled:hover {
    background: #bd1e59;
    box-shadow: 0 4px 12px rgba(255, 56, 92, 0.3);
}







/* Maintain consistent height for the carousel */
#listingCarousel {
    max-height: 500px;
    background-color: #f1f1f1;
}

.carousel-item img {
    height: 500px; /* Force height to match your previous show-img style */
    object-fit: cover;
}

/* Style the arrows to look more like AirHost/Modern UI */
.carousel-control-prev, .carousel-control-next {
    width: 5%;
}

.carousel-control-prev-icon, .carousel-control-next-icon {
    background-color: rgba(0, 0, 0, 0.5);
    background-size: 50% 50%;
    border-radius: 50%;
    padding: 20px;
}

/* Indicators styling */
.carousel-indicators [data-bs-target] {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin: 0 5px;
}











#imageLightbox {
    backdrop-filter: blur(15px);
    background-color: rgba(0, 0, 0, 0.8);
}

#lightboxImg {
    max-height: 85vh;
    max-width: 100%;
    object-fit: contain;
    transition: transform 0.3s ease;
}

/* Custom Nav Buttons */
.lightbox-nav-btn {
    position: absolute;
    background: rgba(255, 255, 255, 0.15);
    color: white;
    border: 1px solid rgba(255,255,255,0.2);
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: 0.2s;
    z-index: 1060;
}

.lightbox-nav-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
}

.lightbox-nav-btn.prev { left: 20px; }
.lightbox-nav-btn.next { right: 20px; }

.zoom-trigger:hover {
    transform: scale(1.1);
    background-color: white !important;
}
</style>






<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  // Configuration from Backend - Using || 0 to handle cases where these aren't set
  const PRICE_PER_DAYS = <%= listing.price %>;
  const CLEANING_FEE = <%= listing.cleaningFee || 0 %>;
  const SERVICE_FEE_PCT = <%= listing.serviceFeePct || 0 %>; 

  // --- GUEST COUNT LOGIC ---
  function changeVal(id, delta) {
    const input = document.getElementById(id);
    const newVal = parseInt(input.value) + delta;
    if (newVal >= input.min && newVal <= input.max) {
      input.value = newVal;
    }
  }

  // --- MODAL CONTROLS ---
  function openPriceModal() { document.getElementById('priceBreakdownModal').style.display = 'flex'; }
  function closePriceModal() { document.getElementById('priceBreakdownModal').style.display = 'none'; }
  function closeConfirmModal() { document.getElementById('customConfirmModal').style.display = 'none'; }
 

 ///// --- FORM SUBMISSION LOGIC -----        

// listing delete button asking conformations logic
 function openListingDeleteModal() {
    const modal = document.getElementById('deleteConfirmModal');
    modal.querySelector('h4').innerText = "Delete Listing?";
    modal.querySelector('p').innerText = "Are you sure? This will permanently remove this property and all associated reviews.";
    
    document.getElementById('finalDeleteBtn').onclick = function() {
        const btn = this;
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Deleting...`;
        
        document.getElementById('listing-delete-form').submit();
    };
    
    // 3. Show the modal
    modal.style.display = 'flex';
}


      function closeDeleteModal() {
    const modal = document.getElementById('deleteConfirmModal');
    modal.style.display = 'none';
    
    // Reset text back to Review defaults so it's ready for review deletion
    modal.querySelector('h4').innerText = "Delete Review?";
    modal.querySelector('p').innerText = "This action cannot be undone. Are you sure you want to remove this feedback?";
    
    currentReviewIdToDelete = null;
    
    // Reset the final delete button click handler back to Review logic
    document.getElementById('finalDeleteBtn').onclick = executeReviewDelete; 
}

// Move your review delete logic into its own named function for easier swapping
function executeReviewDelete() {
    if (currentReviewIdToDelete) {
        const btn = this;
        const form = document.getElementById(`delete-form-${currentReviewIdToDelete}`);
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span>`;
        form.submit();
    }
}


window.onclick = function(event) {
    const confirmModal = document.getElementById('customConfirmModal');
    const priceModal = document.getElementById('priceBreakdownModal');
    const deleteModal = document.getElementById('deleteConfirmModal');

    if (event.target == confirmModal) closeConfirmModal();
    if (event.target == priceModal) closePriceModal();
    if (event.target == deleteModal) closeDeleteModal();
}




 
  function finalSubmit() {
    const confirmBtn = event.target; // Get the button that was clicked
    // Prevent double clicking
    if (confirmBtn.disabled) return; 
    // Disable the button and change text to show progress
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...`;
    // Submit the form
    document.getElementById('reservationForm').submit();
  }

function submitReview(event) {
    const btn = event.currentTarget; 
    const form = document.getElementById('reviewForm');

    // 1. Check if the form is valid (Bootstrap logic)
    if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
        form.classList.add('was-validated'); // Shows red borders/error messages
        return; // Stop here if validation fails
    }

    // 2. Prevent multiple clicks if already processing
    if (btn.disabled) return;

    // 3. UI Updates (Disable button and show spinner)
    btn.disabled = true;
    btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Posting...`;

    // 4. Submit the form to the server
    form.submit();
}



let currentReviewIdToDelete = null;

function openDeleteModal(reviewId) {
    currentReviewIdToDelete = reviewId;
    document.getElementById('deleteConfirmModal').style.display = 'flex';
}

function closeDeleteModal() {
    document.getElementById('deleteConfirmModal').style.display = 'none';
    currentReviewIdToDelete = null;
}

// Attach the actual delete action to the Red button inside the modal
document.getElementById('finalDeleteBtn').onclick = function() {
    if (currentReviewIdToDelete) {
        const btn = this;
        const form = document.getElementById(`delete-form-${currentReviewIdToDelete}`);
        
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span>`;
        
        form.submit();
    }
};




  window.onclick = function(event) {
    const confirmModal = document.getElementById('customConfirmModal');
    const priceModal = document.getElementById('priceBreakdownModal');
    if (event.target == confirmModal) closeConfirmModal();
    if (event.target == priceModal) closePriceModal();
  }

  // --- CALCULATION LOGIC ---
  function updatePriceBreakdown() {
    const checkInVal = document.getElementById('checkIn').value;
    const checkOutVal = document.getElementById('checkOut').value;

    if (checkInVal && checkOutVal) {
      const d1 = new Date(checkInVal);
      const d2 = new Date(checkOutVal);
      const diffTime = d2 - d1;
      const dayCount = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

      if (dayCount > 0) {
        const baseTotal = PRICE_PER_DAYS * dayCount;
        const serviceFee = Math.round(baseTotal * (SERVICE_FEE_PCT / 100));
        const subtotal = baseTotal + CLEANING_FEE + serviceFee;
        const gst = Math.round(subtotal * 0.18); 
        const finalTotal = subtotal + gst;

        // Update Modal UI
        document.getElementById('modalBaseCalc').innerText = `₹ ${PRICE_PER_DAYS.toLocaleString("en-IN")} x ${dayCount} days`;
        document.getElementById('modalBaseTotal').innerText = `₹ ${baseTotal.toLocaleString("en-IN")}`;
        document.getElementById('modalServiceFee').innerText = `₹ ${serviceFee.toLocaleString("en-IN")}`;
        document.getElementById('modalGstAmount').innerText = `₹ ${gst.toLocaleString("en-IN")}`;
        document.getElementById('modalFinalTotal').innerText = `₹ ${finalTotal.toLocaleString("en-IN")}`;
        
        // SYNC TO HIDDEN INPUT FOR BACKEND
        const hiddenInput = document.getElementById('hiddenFinalTotal');
        if(hiddenInput) hiddenInput.value = finalTotal;
      }
    }
  }

  function updateCancellationWindow() {
    const checkInInput = document.getElementById('checkIn');
    const deadlineSpan = document.getElementById('cancel-deadline');
    const checkInDate = new Date(checkInInput.value);
    if (!isNaN(checkInDate)) {
        const deadline = new Date(checkInDate.getTime() - (6 * 60 * 60 * 1000));
        const options = { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' };
        deadlineSpan.innerText = deadline.toLocaleDateString('en-IN', options);
    }
  }

  function handleReservation() {
    const checkIn = document.getElementById('checkIn').value;
    const checkOut = document.getElementById('checkOut').value;
    const adults = document.getElementById('adults').value;
    const children = document.getElementById('children').value;
    
    if (!checkIn || !checkOut) { alert("Please select dates"); return; }
    
    document.getElementById('confirmDetails').innerHTML = `
        <div class="mb-1"><strong>Dates:</strong> ${checkIn} — ${checkOut}</div>
        <div><strong>Guests:</strong> ${adults} Adults, ${children} Children</div>
        <div class="mt-2 text-danger fw-bold">Total: ${document.getElementById('modalFinalTotal').innerText}</div>
    `;
    document.getElementById('customConfirmModal').style.display = 'flex';
  }

  // --- INITIALIZATION ---
  document.addEventListener('DOMContentLoaded', function() {
    const checkIn = document.getElementById('checkIn');
    const checkOut = document.getElementById('checkOut');

    const today = new Date().toISOString().split('T')[0];
    checkIn.setAttribute('min', today);

    function validateDates() {
      if (!checkIn.value) return;
      const checkInDate = new Date(checkIn.value);
      const nextDay = new Date(checkInDate);
      nextDay.setDate(nextDay.getDate() + 1);
      const minCheckOutString = nextDay.toISOString().split('T')[0];
      
      checkOut.setAttribute('min', minCheckOutString);
      if (new Date(checkOut.value) <= checkInDate) {
        checkOut.value = minCheckOutString;
      }
      
      updateCancellationWindow();
      updatePriceBreakdown(); 
    }

    checkIn.addEventListener('change', validateDates);
    checkOut.addEventListener('change', updatePriceBreakdown);
    
    validateDates(); // Initial run

    // --- MAP ---
    <% if (listing.lat && listing.lng) { %>
      const map = L.map('map', { scrollWheelZoom: true }).setView([<%= listing.lat %>, <%= listing.lng %>], 7);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
      const icon = L.divIcon({
        className: 'custom-marker',
        html: "<div style='background-color:#ff385c; width:22px; height:22px; border-radius:50%; border:3px solid white; box-shadow:0 0 5px rgba(0,0,0,0.3)'></div>",
        iconSize: [22, 22],
        iconAnchor: [11, 11]
      });
      L.marker([<%= listing.lat %>, <%= listing.lng %>], { icon: icon }).addTo(map);
      setTimeout(() => { map.invalidateSize(); }, 400);
    <% } %>
  });



// 1. Create the image array from EJS
const listingImages = [<% listing.image.forEach(img => { %> "<%= img.url %>", <% }) %>];
let activeIdx = 0;

function openLightbox(index) {
    activeIdx = index;
    updateLightbox();
    const modal = new bootstrap.Modal(document.getElementById('imageLightbox'));
    modal.show();
}

function changeLightboxImg(step) {
    activeIdx += step;
    if (activeIdx >= listingImages.length) activeIdx = 0;
    if (activeIdx < 0) activeIdx = listingImages.length - 1;
    updateLightbox();
}

function updateLightbox() {
    const img = document.getElementById('lightboxImg');
    const counter = document.getElementById('lightboxCounter');
    
    img.src = listingImages[activeIdx];
    counter.innerText = `${activeIdx + 1} / ${listingImages.length}`;
}

// 2. Keyboard Support
document.addEventListener('keydown', (e) => {
    const lb = document.getElementById('imageLightbox');
    if (lb.classList.contains('show')) {
        if (e.key === "ArrowRight") changeLightboxImg(1);
        if (e.key === "ArrowLeft") changeLightboxImg(-1);
    }
});
</script>