<% layout("layouts/boilerplate") %>

<div class="container show-container mt-5">
  <div class="row">
    <div class="col-12 mb-3">
      <h2 class="fw-bold"><%= listing.title %></h2>
      <div class="d-flex justify-content-between align-items-center">
        <p class="text-muted mb-0">
          <span class="material-symbols-outlined fs-6 align-middle">location_on</span>
          <%= listing.location %>, <%= listing.country %>
        </p>
        
        <% if (currentUser && (currentUser.role === "admin" || (listing.owner && currentUser._id.toString() === listing.owner._id.toString()))) { %>
          <div class="d-flex gap-2">
            <a href="/listings/<%= listing._id %>/edit" class="btn btn-air-secondary btn-sm px-3">
              <span class="material-symbols-outlined fs-6 align-middle me-1">edit</span> Edit
            </a>
            <form action="/listings/<%= listing._id %>?_method=DELETE" method="POST">
              <button type="submit" class="btn btn-air-danger btn-sm px-3" onclick="return confirm('Delete this listing?')">
                <span class="material-symbols-outlined fs-6 align-middle me-1">delete</span> Delete
              </button>
            </form>
          </div>
        <% } %>
      </div>
    </div>

    <div class="col-12 mb-4">
      <div class="show-img-container shadow-sm">
        <img src="<%= listing.image.url %>" class="show-img rounded-4" alt="<%= listing.title %>">
        <% if (listing.price > 10000) { %>
          <div class="premium-badge">Premium Stay</div>
        <% } %>
      </div>
    </div>

    <div class="col-lg-7">
      <div class="details-card p-4 rounded-4 shadow-sm border mb-4">
        <div class="d-flex align-items-center mb-4 pb-3 border-bottom">
          <div class="owner-avatar me-3">
            <%= listing.owner ? listing.owner.username.charAt(0).toUpperCase() : 'O' %>
          </div>
          <div>
            <h5 class="mb-0 fw-bold">Hosted by <%= listing.owner ? listing.owner.username : "Professional Host" %></h5>
            <p class="text-muted small mb-0">Member since 2026</p>
          </div>
        </div>

        <h5 class="fw-bold mb-3">About this place</h5>
        <p class="listing-desc text-secondary"><%= listing.description %></p>
        
        <div class="price-highlight mt-4 p-3 rounded-3 d-flex justify-content-between align-items-center">
          <span>Current Price</span>
          <h4 class="mb-0 fw-bold text-dark">â‚¹ <%= listing.price.toLocaleString("en-IN") %> <small class="fw-light text-muted">/ night</small></h4>
        </div>
      </div>

      <% if (listing.lat && listing.lng) { %>
        <div class="mb-5">
          <h5 class="fw-bold mb-3">Where you'll be</h5>
          <div id="map" class="rounded-4 shadow-sm border"></div>
        </div>
      <% } %>
    </div>

    <div class="col-lg-5">
      <div class="review-section sticky-top p-4 rounded-4 shadow-sm border bg-white" style="top: 100px; z-index: 1;">
        <h5 class="fw-bold mb-4">Guest Reviews</h5>
        
        <div class="review-list custom-scrollbar mb-4" style="max-height: 400px; overflow-y: auto;">
          <% if (listing.reviews && listing.reviews.length > 0) { %>
            <% listing.reviews.forEach(review => { %>
              <div class="review-card p-3 rounded-3 border mb-3 bg-light-subtle">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <div class="fw-bold small text-dark"><%= review.author ? review.author.username : "Guest" %></div>
                  <div class="d-flex align-items-center">
                    <span class="material-symbols-outlined fs-6 text-warning me-1">star</span>
                    <span class="small fw-bold"><%= review.rating %></span>
                  </div>
                </div>
                <p class="small text-muted mb-2"><%= review.comment %></p>
                <% if (currentUser && (currentUser.role === "admin" || (review.author && currentUser._id.toString() === review.author._id.toString()))) { %>
                  <form action="/reviews/<%= review._id %>?_method=DELETE" method="POST">
                    <button class="btn btn-link text-danger p-0 small text-decoration-none" type="submit">Delete</button>
                  </form>
                <% } %>
              </div>
            <% }) %>
          <% } else { %>
            <div class="text-center py-4">
              <span class="material-symbols-outlined fs-1 text-light">chat_bubble</span>
              <p class="text-muted small mt-2">No reviews yet. Be the first!</p>
            </div>
          <% } %>
        </div>

        <% if (currentUser) { %>
          <div class="border-top pt-4">
            <h6 class="fw-bold mb-3">Add a Review</h6>
            <form action="/listings/<%= listing._id %>/reviews" method="POST">
              <div class="mb-3">
                <label class="form-label small fw-semibold">Rating</label>
                <div class="star-rating d-flex flex-row-reverse justify-content-end">
                   <% [5,4,3,2,1].forEach(num => { %>
                    <input type="radio" name="rating" value="<%= num %>" id="star<%= num %>" required>
                    <label for="star<%= num %>"><span class="material-symbols-outlined">star</span></label>
                   <% }) %>
                </div>
              </div>
              <div class="mb-3">
                <textarea name="comment"rows="2" class="form-control rounded-3" placeholder="Tell us about your stay..." required></textarea>
              </div>
              <button class="btn btn-air-primary w-100 py-2 fw-bold">Post Review</button>
            </form>
          </div>
        <% } %>
      </div>
    </div>
  </div>
  
  <div class="text-center mt-5 mb-5">
    <a href="/" class="text-muted text-decoration-none">
      <span class="material-symbols-outlined align-middle">arrow_back</span> Back to listings
    </a>
  </div>
</div>

<style>
  /* Base Styles */
  .show-container { max-width: 1100px; margin: auto; }
  
  /* Buttons */
  .btn-air-primary { background: #ff385c; color: white; border: none; transition: 0.3s; }
  .btn-air-primary:hover { background: #e31c5f; transform: scale(1.02); }
  .btn-air-secondary { background: #f8f9fa; border: 1px solid #ddd; color: #222; }
  .btn-air-danger { background: #fff; border: 1px solid #ff385c; color: #ff385c; }

  /* Hero Image */
  .show-img-container { position: relative; overflow: hidden; border-radius: 1.5rem; }
  .show-img { width: 100%; max-height: 500px; object-fit: cover; }
  .premium-badge {
    position: absolute; top: 20px; left: 20px;
    background: rgba(255,255,255,0.9); padding: 5px 15px;
    border-radius: 50px; font-weight: 800; font-size: 0.7rem; text-transform: uppercase;
  }

  /* Owner Avatar */
  .owner-avatar {
    width: 50px; height: 50px; background: #222; color: white;
    border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;
  }

  /* Price Highlight */
  .price-highlight { background: #f7f7f7; border: 1px solid #eee; }

  /* Map */
  #map { height: 350px; width: 100%; }

  /* Star Rating Input */
  .star-rating input { display: none; }
  .star-rating label { color: #ddd; cursor: pointer; transition: 0.2s; }
  .star-rating label:hover,
  .star-rating label:hover ~ label,
  .star-rating input:checked ~ label { color: #ff385c; font-variation-settings: 'FILL' 1; }

  /* Custom Scrollbar */
  .custom-scrollbar::-webkit-scrollbar { width: 5px; }
  .custom-scrollbar::-webkit-scrollbar-thumb { background: #eee; border-radius: 10px; }

  @media (max-width: 991px) {
    .review-section { position: static; margin-top: 2rem; }
  }
</style>

<% if (listing.lat && listing.lng) { %>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  const map = L.map('map', { scrollWheelZoom: false }).setView([<%= listing.lat %>, <%= listing.lng %>], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  const icon = L.divIcon({
    className: 'custom-div-icon',
    html: "<div style='background-color:#ff385c; width:20px; height:20px; border-radius:50%; border:2px solid white;'></div>",
    iconSize: [20, 20],
    iconAnchor: [10, 10]
  });
  L.marker([<%= listing.lat %>, <%= listing.lng %>], { icon: icon }).addTo(map);
</script>
<% } %>