<% layout('layouts/boilerplate') %>

<div class="container py-5">
    <div class="row">
        <div class="col-lg-4 mb-4">
            <div class="card border-0 shadow-sm rounded-4 overflow-hidden sticky-top" style="top: 7rem; z-index: 10;">
                <div class="card-header bg-dark py-4 text-center border-0">
                    <div class="admin-avatar-lg mx-auto mb-3">
                        <%= user.username.charAt(0).toUpperCase() %>
                    </div>
                    <h5 class="text-white mb-0"><%= user.username %></h5>
                    <span class="badge rounded-pill mt-2 <%= user.status === 'blocked' ? 'bg-danger' : 'bg-success' %>">
                        <%= user.status.toUpperCase() %>
                    </span>
                </div>
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between mb-2 small">
                        <span class="text-muted">Account ID:</span>
                        <code class="text-dark"><%= user._id.toString().substring(0, 8) %>...</code>
                    </div>
                    <div class="d-flex justify-content-between mb-2 small">
                        <span class="text-muted">Member Since:</span>
                        <span class="fw-medium"><%= new Date(user.createdAt).toLocaleDateString('en-IN', { month: 'short', year: 'numeric' }) %></span>
                    </div>
                    <hr class="my-3 opacity-50">
                    <div class="row text-center">
                        <div class="col-6 border-end">
                            <div class="h6 fw-bold mb-0"><%= user.listings ? user.listings.length : 0 %></div>
                            <div class="extra-small text-muted">LISTINGS</div>
                        </div>
                        <div class="col-6">
                            <div class="h6 fw-bold mb-0 text-primary">Active</div>
                            <div class="extra-small text-muted">STATUS</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card border-0 shadow-sm rounded-4 p-4 p-md-5 mb-5">
                <h3 class="fw-bold mb-4 text-dark">Account Intelligence</h3>
                
                <form action="/admin/users/<%= user._id %>?_method=PUT" method="POST" class="needs-validation" novalidate>
                    <div class="row g-3">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold small">Username</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-0"><i class="fa-solid fa-user text-muted"></i></span>
                                <input type="text" name="user[username]" value="<%= user.username %>" class="form-control border-0 bg-light" required>
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold small">Official Email</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-0"><i class="fa-solid fa-envelope text-muted"></i></span>
                                <input type="email" name="user[email]" value="<%= user.email %>" class="form-control border-0 bg-light" required>
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold small">Access Level</label>
                            <select name="user[role]" class="form-select border-0 bg-light">
                                <option value="user" <%= user.role === 'user' ? 'selected' : '' %>>Standard User</option>
                                <option value="admin" <%= user.role === 'admin' ? 'selected' : '' %>>Platform Administrator</option>
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold small">Account Integrity</label>
                            <select name="user[status]" class="form-select border-0 <%= user.status === 'blocked' ? 'bg-danger-subtle text-danger' : 'bg-success-subtle text-success' %>">
                                <option value="active" <%= user.status === 'active' ? 'selected' : '' %>>Active (Unrestricted)</option>
                                <option value="blocked" <%= user.status === 'blocked' ? 'selected' : '' %>>Blocked (Suspended)</option>
                            </select>
                        </div>

                        <div class="col-12 mt-4">
                            <h6 class="fw-bold border-bottom pb-2 mb-3">Contact Information</h6>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold small">Phone Number</label>
                                    <input type="text" name="user[phone]" value="<%= user.phone || '' %>" class="form-control border-0 bg-light" placeholder="+91 00000 00000">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold small">Location</label>
                                    <input type="text" name="user[location]" value="<%= user.location || '' %>" class="form-control border-0 bg-light" placeholder="e.g. Mumbai, India">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex gap-2 mt-4">
                        <button class="btn btn-dark px-4 py-2 fw-bold rounded-pill">Save Changes</button>
                        <a href="/admin" class="btn btn-outline-secondary px-4 py-2 rounded-pill">Cancel</a>
                    </div>
                </form>

                <div class="mt-5 pt-4 border-top">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h5 class="fw-bold mb-0 text-dark">Managed Inventory</h5>
                            <p class="text-muted x-small mb-0">Owned properties & listings</p>
                        </div>
                        <div class="bg-dark text-white px-3 py-1 rounded-pill fw-bold" style="font-size: 0.7rem;">
                            <%= user.listings ? user.listings.length : 0 %> LISTINGS
                        </div>
                    </div>

                    <% if(user.listings && user.listings.length > 0) { %>
                        <div class="row g-3">
                            <% for(let listing of user.listings) { %>
                                <div class="col-md-6">
                                    <div class="card border-0 shadow-sm rounded-4 h-100 property-redirect-card">
                                        <div class="position-relative overflow-hidden rounded-top-4">
                                            <img src="<%= listing.image.url %>" class="card-img-top property-img" style="height: 140px; object-fit: cover;" alt="listing">
                                            <div class="price-glass-badge">â‚¹<%= listing.price.toLocaleString("en-IN") %></div>
                                        </div>
                                        <div class="card-body p-3 d-flex flex-column">
                                            <h6 class="fw-bold text-dark text-truncate mb-1 small"><%= listing.title %></h6>
                                            <p class="text-muted extra-small mb-3">
                                                <i class="fa-solid fa-location-dot me-1 text-danger"></i><%= listing.location %>
                                            </p>
                                            <a href="/listings/<%= listing._id %>" class="btn btn-inspect w-100 rounded-pill fw-bold">
                                                <span>Inspect</span><i class="fa-solid fa-arrow-right ms-2"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            <% } %>
                        </div>
                    <% } else { %>
                        <div class="text-center py-4 bg-light rounded-4 border border-dashed">
                            <p class="small fw-bold text-muted mb-0">No active inventory found.</p>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* 1. Base UI Components */
    .admin-avatar-lg {
        width: 80px; height: 80px;
        background: linear-gradient(135deg, #FF385C 0%, #E61E4D 100%);
        color: white; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 2rem; font-weight: 800;
        box-shadow: 0 4px 15px rgba(230, 30, 77, 0.3);
    }

    .extra-small { font-size: 0.65rem; letter-spacing: 0.5px; font-weight: 800; }
    .x-small { font-size: 0.75rem; color: #6c757d; }
    .bg-danger-subtle { background-color: #fee2e2 !important; }
    .bg-success-subtle { background-color: #dcfce7 !important; }

    /* 2. Listing Cards */
    .property-redirect-card {
        transition: all 0.3s ease;
        border: 1px solid #f1f5f9 !important;
    }

    .property-redirect-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.08) !important;
        border-color: #ff385c !important;
    }

    .property-img { transition: transform 0.5s ease; }
    .property-redirect-card:hover .property-img { transform: scale(1.08); }

    .price-glass-badge {
        position: absolute; top: 10px; right: 10px;
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(4px);
        padding: 4px 10px; border-radius: 50px;
        font-size: 0.7rem; font-weight: 800; color: #1a202c;
    }

    .btn-inspect {
        background-color: transparent; border: 1px solid #e2e8f0;
        color: #64748b; font-size: 0.65rem;
        text-transform: uppercase; padding: 6px 0; transition: all 0.2s;
    }

    .property-redirect-card:hover .btn-inspect {
        background-color: #ff385c; border-color: #ff385c; color: #fff;
    }

    .border-dashed { border: 2px dashed #e2e8f0 !important; }
</style>