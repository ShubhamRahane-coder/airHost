<% layout('layouts/boilerplate') %>

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

<div class="container-fluid py-5 px-lg-5 bg-light min-vh-100">
    
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-5 gap-3">
        <div>
            <h1 class="display-6 fw-bold text-dark mb-1">Reservation Command Center</h1>
            <p class="text-muted mb-0">Manage guest verification, stay dates, and occupancy details.</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-dark rounded-pill px-4 shadow" onclick="window.print()">
                <span class="material-symbols-outlined align-middle fs-6 me-1">download</span> Export Ledger
            </button>
        </div>
    </div>

    <% if (listings && listings.length > 0) { %>
        <% for(let listing of listings) { %>
            <div class="listing-group mb-5">
                
                <div class="d-flex align-items-center mb-4 p-3 bg-white rounded-4 shadow-sm border-start border-4 border-dark">
                    <img src="<%= listing.image.url %>" class="rounded-3 shadow-sm me-3" width="70" height="70" style="object-fit: cover;">
                    <div class="flex-grow-1">
                        <h4 class="fw-bold mb-0 text-dark"><%= listing.title %></h4>
                        <p class="text-muted small mb-0">
                            <span class="material-symbols-outlined fs-6 align-middle">location_on</span> <%= listing.location %> | 
                            <strong>Total Earnings:</strong> 
                            <span class="text-success">
                                ₹<%= (listing.reservations && listing.reservations.length > 0) 
                                    ? listing.reservations.reduce((acc, res) => acc + (res.price || 0), 0).toLocaleString('en-IN') 
                                    : '0' %>
                            </span>
                        </p>
                    </div>
                    <div class="text-end d-none d-md-block">
                        <span class="badge bg-dark rounded-pill px-3 py-2">
                            <%= (listing.reservations) ? listing.reservations.length : 0 %> Bookings
                        </span>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-5 overflow-hidden">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-dark text-white text-uppercase">
                                <tr class="extra-small">
                                    <th class="ps-4 py-3">Guest Info & Occupancy</th>
                                    <th>Stay Window</th>
                                    <th>Verification</th>
                                    <th>Financials</th>
                                    <th>Status</th>
                                    <th class="pe-4 text-end">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if (listing.reservations && listing.reservations.length > 0) { %>
                                    <% for(let resv of listing.reservations) { %>
                                        <% if (!resv) continue; %>
                                        <tr>
                                            <td class="ps-4">
                                                <div class="d-flex align-items-center gap-3">
                                                    <div class="guest-avatar">
                                                        <%= resv.guest ? resv.guest.username.substring(0, 2).toUpperCase() : '??' %>
                                                    </div>
                                                    <div>
                                                        <div class="fw-bold"><%= resv.guest ? resv.guest.username : 'Deleted User' %></div>
                                                        <div class="text-muted x-small d-flex align-items-center gap-1">
                                                            <span class="material-symbols-outlined" style="font-size: 14px;">groups</span>
                                                            <%= resv.adults || 0 %> Adults, <%= resv.children || 0 %> Children
                                                        </div>
                                                        <code class="text-muted x-small">#<%= resv._id.toString().slice(-6).toUpperCase() %></code>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="fw-semibold small"><%= resv.checkIn.toDateString() %></div>
                                                <div class="text-muted x-small">to <%= resv.checkOut.toDateString() %></div>
                                            </td>
                                            <td>
                                                <div class="status-indicator <%= resv.isVerified ? 'success' : 'warning' %>">
                                                    <span class="material-symbols-outlined fs-6">
                                                        <%= resv.isVerified ? 'check_circle' : 'error' %>
                                                    </span> 
                                                    <%= resv.isVerified ? 'Verified' : 'Pending' %>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="fw-bold">₹<%= (resv.price || 0).toLocaleString('en-IN') %></div>
                                                <div class="text-muted x-small">via Online</div>
                                            </td>
                                            <td>
                                                <span class="status-badge <%= (resv.status || 'pending').toLowerCase() %>">
                                                    <%= resv.status || 'Pending' %>
                                                </span>
                                            </td>
                                            <td class="pe-4 text-end">
                                                <div class="btn-group shadow-sm rounded-pill overflow-hidden border">
                                                    <button class="btn btn-sm btn-white px-3" data-bs-toggle="modal" data-bs-target="#editModal<%= resv._id %>">
                                                        <span class="material-symbols-outlined fs-6 align-middle">edit</span>
                                                    </button>
                                                    <form action="/dashboard/reservations/<%= resv._id %>?_method=DELETE" method="POST" class="d-inline">
                                                        <button class="btn btn-sm btn-white px-3 text-danger border-start" onclick="return confirm('Delete this reservation?')">
                                                            <span class="material-symbols-outlined fs-6 align-middle">delete</span>
                                                        </button>
                                                    </form>
                                                </div>
                                            </td>
                                        </tr>

                                        <div class="modal fade" id="editModal<%= resv._id %>" tabindex="-1" aria-hidden="true">
                                            <div class="modal-dialog modal-dialog-centered">
                                                <div class="modal-content border-0 shadow rounded-4">
                                                    <div class="modal-header border-0">
                                                        <h5 class="fw-bold">Update Reservation</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                    </div>
                                                    <form action="/dashboard/reservations/<%= resv._id %>?_method=PUT" method="POST">
                                                        <div class="modal-body py-0">
                                                            <div class="mb-3">
                                                                <label class="form-label small fw-bold">Booking Status</label>
                                                                <select class="form-select" name="reservation[status]">
                                                                    <option value="Confirmed" <%= resv.status === 'Confirmed' ? 'selected' : '' %>>Confirmed</option>
                                                                    <option value="Pending" <%= resv.status === 'Pending' ? 'selected' : '' %>>Pending</option>
                                                                    <option value="Cancelled" <%= resv.status === 'Cancelled' ? 'selected' : '' %>>Cancelled</option>
                                                                </select>
                                                            </div>
                                                            <div class="row g-2 mb-3">
                                                                <div class="col-6">
                                                                    <label class="form-label small fw-bold">Check-in</label>
                                                                    <input type="date" class="form-control" name="reservation[checkIn]" value="<%= resv.checkIn instanceof Date ? resv.checkIn.toISOString().split('T')[0] : '' %>">
                                                                </div>
                                                                <div class="col-6">
                                                                    <label class="form-label small fw-bold">Check-out</label>
                                                                    <input type="date" class="form-control" name="reservation[checkOut]" value="<%= resv.checkOut instanceof Date ? resv.checkOut.toISOString().split('T')[0] : '' %>">
                                                                </div>
                                                            </div>
                                                            <div class="row g-2 mb-3">
                                                                <div class="col-6">
                                                                    <label class="form-label small fw-bold">Adults</label>
                                                                    <input type="number" class="form-control" name="reservation[adults]" value="<%= resv.adults || 1 %>" min="1">
                                                                </div>
                                                                <div class="col-6">
                                                                    <label class="form-label small fw-bold">Children</label>
                                                                    <input type="number" class="form-control" name="reservation[children]" value="<%= resv.children || 0 %>" min="0">
                                                                </div>
                                                            </div>
                                                            <div class="form-check form-switch mb-3">
                                                                <input class="form-check-input" type="checkbox" name="reservation[isVerified]" <%= resv.isVerified ? 'checked' : '' %>>
                                                                <label class="form-check-label small fw-bold">Identity Verified</label>
                                                            </div>
                                                        </div>
                                                        <div class="modal-footer border-0">
                                                            <button type="submit" class="btn btn-dark w-100 rounded-pill py-2">Save Changes</button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    <% } %>
                                <% } else { %>
                                    <tr>
                                        <td colspan="6" class="text-center py-5 text-muted small">No reservations yet.</td>
                                    </tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        <% } %>
    <% } else { %>
        <div class="text-center py-5 bg-white rounded-5 shadow-sm border">
            <span class="material-symbols-outlined display-1 text-muted">bed</span>
            <h3 class="mt-3 fw-bold">No Active Listings</h3>
            <p class="text-muted">You haven't added any properties to receive reservations.</p>
            <a href="/listings/new" class="btn btn-danger rounded-pill px-5 py-2">Create Listing</a>
        </div>
    <% } %>
</div>

<style>
    .extra-small { font-size: 0.72rem !important; font-weight: 700; letter-spacing: 0.8px; }
    .x-small { font-size: 0.68rem; }
    .guest-avatar {
        width: 38px; height: 38px;
        background: #f8f9fa; border: 1px solid #dee2e6;
        display: flex; align-items: center; justify-content: center;
        border-radius: 50%; font-weight: 800; font-size: 0.75rem;
    }
    .status-indicator { display: flex; align-items: center; gap: 4px; font-size: 0.8rem; font-weight: 600; }
    .status-indicator.success { color: #198754; }
    .status-indicator.warning { color: #f59e0b; }
    .status-badge { padding: 4px 10px; border-radius: 50px; font-size: 0.65rem; font-weight: 800; text-transform: uppercase; }
    .status-badge.confirmed { background: #d1fae5; color: #065f46; }
    .status-badge.pending { background: #fef3c7; color: #92400e; }
    .status-badge.cancelled { background: #fee2e2; color: #991b1b; }
    .btn-white { background: #fff; }
    .rounded-5 { border-radius: 1.25rem !important; }
</style>